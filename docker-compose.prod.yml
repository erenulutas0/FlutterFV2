services:
  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set for production}
    ports: !override []

  redis:
    ports: !override []
    command: redis-server --appendonly yes --requirepass ${SPRING_DATA_REDIS_PASSWORD:?SPRING_DATA_REDIS_PASSWORD must be set for production} --maxmemory ${REDIS_MAXMEMORY:-256mb} --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}

  backend:
    environment:
      SPRING_PROFILES_ACTIVE: docker,prod
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set for production}
      SPRING_DATA_REDIS_PASSWORD: ${SPRING_DATA_REDIS_PASSWORD:?SPRING_DATA_REDIS_PASSWORD must be set for production}
      IYZICO_API_KEY: ${IYZICO_API_KEY:?IYZICO_API_KEY must be set for production}
      IYZICO_API_SECRET: ${IYZICO_API_SECRET:?IYZICO_API_SECRET must be set for production}
      IYZICO_API_BASE_URL: ${IYZICO_API_BASE_URL:?IYZICO_API_BASE_URL must be set for production}
      GROQ_API_KEY: ${GROQ_API_KEY:?GROQ_API_KEY must be set for production}
      APP_CORS_ALLOWED_ORIGINS: ${APP_CORS_ALLOWED_ORIGINS:?APP_CORS_ALLOWED_ORIGINS must be set for production}
      PIPER_TTS_PATH: ${PIPER_TTS_PATH:-/opt/piper/piper}
      PIPER_TTS_DEFAULT_MODEL: ${PIPER_TTS_DEFAULT_MODEL:-en_US-amy-medium.onnx}
      APP_SECURITY_AUTH_RATE_LIMIT_REDIS_FALLBACK_MODE: ${APP_SECURITY_AUTH_RATE_LIMIT_REDIS_FALLBACK_MODE:-memory}
      APP_SECURITY_AUTH_RATE_LIMIT_REDIS_FAILURE_BLOCK_SECONDS: ${APP_SECURITY_AUTH_RATE_LIMIT_REDIS_FAILURE_BLOCK_SECONDS:-60}
    ports: !override
      - "${BACKEND_HTTP_PORT:-8082}:8082"

  alertmanager:
    environment:
      ALERTMANAGER_DEFAULT_WEBHOOK_URL: ${ALERTMANAGER_DEFAULT_WEBHOOK_URL:?ALERTMANAGER_DEFAULT_WEBHOOK_URL must be set for production}
      ALERTMANAGER_CRITICAL_WEBHOOK_URL: ${ALERTMANAGER_CRITICAL_WEBHOOK_URL:?ALERTMANAGER_CRITICAL_WEBHOOK_URL must be set for production}
      ALERTMANAGER_WARNING_WEBHOOK_URL: ${ALERTMANAGER_WARNING_WEBHOOK_URL:?ALERTMANAGER_WARNING_WEBHOOK_URL must be set for production}
    entrypoint:
      - /bin/sh
      - -ec
    command:
      - |
        cat > /tmp/alertmanager.yml <<EOF
        global:
          resolve_timeout: 5m

        route:
          receiver: default-webhook
          group_by:
            - alertname
            - component
            - severity
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 2h
          routes:
            - matchers:
                - severity="critical"
              receiver: critical-webhook
            - matchers:
                - severity="warning"
              receiver: warning-webhook

        receivers:
          - name: default-webhook
            webhook_configs:
              - url: "${ALERTMANAGER_DEFAULT_WEBHOOK_URL}"
                send_resolved: true

          - name: critical-webhook
            webhook_configs:
              - url: "${ALERTMANAGER_CRITICAL_WEBHOOK_URL}"
                send_resolved: true

          - name: warning-webhook
            webhook_configs:
              - url: "${ALERTMANAGER_WARNING_WEBHOOK_URL}"
                send_resolved: true
        EOF
        exec /bin/alertmanager --config.file=/tmp/alertmanager.yml --storage.path=/alertmanager --web.listen-address=:9093
    volumes: !override
      - alertmanager_data:/alertmanager

  alert-webhook:
    profiles:
      - nonprod-only
